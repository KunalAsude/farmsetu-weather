{% extends 'base.html' %}

{% block title %}Dashboard - UK Weather Data{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1><i class="fas fa-tachometer-alt"></i> Weather Data Dashboard</h1>
        <p class="lead">UK MetOffice Weather Data Analysis</p>
    </div>
</div>

<!-- Statistics Cards -->
<div class="row mb-4">
    <div class="col-md-4">
        <div class="card stats-card">
            <div class="card-body">
                <h5 class="card-title">
                    <i class="fas fa-database text-primary"></i> Total Records
                </h5>
                <h3 class="text-primary">{{ total_records|default:0 }}</h3>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card stats-card">
            <div class="card-body">
                <h5 class="card-title">
                    <i class="fas fa-calendar text-success"></i> Data Range
                </h5>
                <h3 class="text-success">{{ earliest_year|default:"N/A" }} - {{ latest_year|default:"N/A" }}</h3>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card stats-card">
            <div class="card-body">
                <h5 class="card-title">
                    <i class="fas fa-map-marked-alt text-info"></i> Regions
                </h5>
                <h3 class="text-info">{{ regions.count }}</h3>
            </div>
        </div>
    </div>
</div>

<!-- Data Controls -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-sync"></i> Data Refresh
            </div>
            <div class="card-body">
                <button class="btn btn-info" onclick="refreshDashboard()">
                    <i class="fas fa-redo"></i> Refresh Dashboard
                </button>
                <div class="mt-2 text-muted small">
                    <i class="fas fa-info-circle"></i> Data is automatically loaded from the database.
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Quick Charts -->
<div class="row">
    <div class="col-md-6">
        <div class="card h-100">
            <div class="card-header">
                <i class="fas fa-thermometer-half"></i> UK Temperature Trend (Last 2 Years)
            </div>
            <div class="card-body">
                <canvas id="tempChart" height="200"></canvas>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card h-100">
            <div class="card-header">
                <i class="fas fa-cloud-rain"></i> UK Rainfall Trend (Last 2 Years)
            </div>
            <div class="card-body">
                <canvas id="rainChart" height="200"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Yearly Distribution -->
<div class="row mt-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-chart-pie"></i> Yearly Averages
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <canvas id="yearlyTempChart" height="250"></canvas>
                    </div>
                    <div class="col-md-6">
                        <canvas id="yearlyRainChart" height="250"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Data Tables -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-table"></i> Recent Weather Data
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped" id="weatherTable">
                        <thead>
                            <tr>
                                <th>Region</th>
                                <th>Parameter</th>
                                <th>Year</th>
                                <th>Month</th>
                                <th>Value</th>
                                <th>Unit</th>
                            </tr>
                        </thead>
                        <tbody id="weatherTableBody">
                            <tr>
                                <td colspan="6" class="text-center">Loading...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// Dashboard JavaScript
let tempChart, rainChart, yearlyTempChart, yearlyRainChart;

// Initialize dashboard
document.addEventListener('DOMContentLoaded', function() {
    loadWeatherData();
    initializeCharts();
});

// Refresh dashboard
function refreshDashboard() {
    location.reload();
}

// Load weather data for table
function loadWeatherData() {
    fetch('/api/weather-data/?limit=50')
        .then(response => response.json())
        .then(data => {
            const tbody = document.getElementById('weatherTableBody');
            tbody.innerHTML = '';
            
            if (data.results && data.results.length > 0) {
                data.results.forEach(record => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${record.region_name}</td>
                        <td>${record.parameter_name}</td>
                        <td>${record.year}</td>
                        <td>${record.month}</td>
                        <td>${record.value}</td>
                        <td>${record.parameter_unit}</td>
                    `;
                    tbody.appendChild(row);
                });
            } else {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center">No data available</td></tr>';
            }
        })
        .catch(error => {
            console.error('Error loading weather data:', error);
            document.getElementById('weatherTableBody').innerHTML = 
                '<tr><td colspan="6" class="text-center text-danger">Error loading data</td></tr>';
        });
}

// Initialize charts
function initializeCharts() {
    // Temperature Chart
    const tempCtx = document.getElementById('tempChart').getContext('2d');
    tempChart = new Chart(tempCtx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: 'Temperature (°C)',
                data: [],
                borderColor: 'rgb(255, 99, 132)',
                backgroundColor: 'rgba(255, 99, 132, 0.2)',
                tension: 0.1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: false
                }
            }
        }
    });

    // Rainfall Chart
    const rainCtx = document.getElementById('rainChart').getContext('2d');
    rainChart = new Chart(rainCtx, {
        type: 'bar',
        data: {
            labels: [],
            datasets: [{
                label: 'Rainfall (mm)',
                data: [],
                backgroundColor: 'rgba(0, 82, 204, 0.9)',  // Darker blue with higher opacity
                borderColor: 'rgba(0, 51, 153, 1)',       // Even darker blue for border
                borderWidth: 1,
                borderRadius: 4,                          // Slight rounding of bar corners
                borderSkipped: false                      // Apply border radius to all sides
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });

    // Load chart data
    loadChartData();
}

// Load chart data
function loadChartData() {
    // Load temperature data for line chart
    fetch('/api/chart-data/?region=UK&parameter=Tmean')
        .then(response => response.json())
        .then(data => {
            if (data.labels && data.values) {
                // Show last 24 months only for line chart
                const recentData = data.labels.slice(-24).map((label, index) => ({
                    label: label,
                    value: data.values[data.values.length - 24 + index]
                }));
                
                tempChart.data.labels = recentData.map(d => d.label);
                tempChart.data.datasets[0].data = recentData.map(d => d.value);
                tempChart.update();
                
                // Process data for yearly temperature pie chart
                processYearlyData(data, 'temperature');
            }
        })
        .catch(error => console.error('Error loading temperature data:', error));

    // Load rainfall data for line chart
    fetch('/api/chart-data/?region=UK&parameter=Rainfall')
        .then(response => response.json())
        .then(data => {
            if (data.labels && data.values) {
                // Show last 24 months only for line chart
                const recentData = data.labels.slice(-24).map((label, index) => ({
                    label: label,
                    value: data.values[data.values.length - 24 + index]
                }));
                
                rainChart.data.labels = recentData.map(d => d.label);
                rainChart.data.datasets[0].data = recentData.map(d => d.value);
                rainChart.update();
                
                // Process data for yearly rainfall pie chart
                processYearlyData(data, 'rainfall');
            }
        })
        .catch(error => console.error('Error loading rainfall data:', error));
}

// Process data for yearly pie charts
function processYearlyData(data, type) {
    // Group data by year
    const yearlyData = {};
    
    data.labels.forEach((label, index) => {
        const year = label.split('-')[0]; // Extract year from date
        if (!yearlyData[year]) {
            yearlyData[year] = [];
        }
        if (data.values[index] !== null) {
            yearlyData[year].push(parseFloat(data.values[index]));
        }
    });
    
    // Calculate yearly averages
    const years = Object.keys(yearlyData).sort();
    const averages = years.map(year => {
        const values = yearlyData[year];
        const sum = values.reduce((a, b) => a + b, 0);
        return parseFloat((sum / values.length).toFixed(2));
    });
    
    // Update the appropriate chart
    if (type === 'temperature') {
        updateYearlyChart('yearlyTempChart', 'Yearly Average Temperature (°C)', years, averages, 'rgb(255, 99, 132)');
    } else if (type === 'rainfall') {
        updateYearlyChart('yearlyRainChart', 'Yearly Average Rainfall (mm)', years, averages, 'rgb(54, 162, 235)');
    }
}

// Update yearly pie charts
function updateYearlyChart(chartId, label, years, values, color) {
    const ctx = document.getElementById(chartId).getContext('2d');
    
    // Generate colors for each year
    const backgroundColors = years.map((_, i) => {
        const opacity = 0.7 + (i * 0.05);
        return color.replace(')', `, ${opacity})`).replace('rgb', 'rgba');
    });
    
    // If chart already exists, update it. Otherwise, create new.
    if (window[chartId]) {
        window[chartId].data.labels = years;
        window[chartId].data.datasets[0].data = values;
        window[chartId].update();
    } else {
        window[chartId] = new Chart(ctx, {
            type: 'pie',  // Changed from 'bar' to 'pie'
            data: {
                labels: years,
                datasets: [{
                    label: label,
                    data: values,
                    backgroundColor: backgroundColors,
                    borderColor: color,
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'right',
                    },
                    title: {
                        display: true,
                        text: label,
                        padding: {
                            bottom: 10
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return `${context.label}: ${context.raw} ${label.includes('Temperature') ? '°C' : 'mm'}`;
                            }
                        }
                    }
                }
            }
        });
    }
}
</script>
{% endblock %}