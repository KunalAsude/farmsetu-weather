{% extends 'base.html' %}

{% block title %}Dashboard - UK Weather Data{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1><i class="fas fa-tachometer-alt"></i> Weather Data Dashboard</h1>
        <p class="lead">UK MetOffice Weather Data Analysis</p>
    </div>
</div>

<!-- Statistics Cards -->
<div class="row mb-4">
    <div class="col-md-4">
        <div class="card stats-card">
            <div class="card-body">
                <h5 class="card-title">
                    <i class="fas fa-database text-primary"></i> Total Records
                </h5>
                <h3 class="text-primary">{{ total_records|default:0 }}</h3>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card stats-card">
            <div class="card-body">
                <h5 class="card-title">
                    <i class="fas fa-calendar text-success"></i> Data Range
                </h5>
                <h3 class="text-success">{{ earliest_year|default:"N/A" }} - {{ latest_year|default:"N/A" }}</h3>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card stats-card">
            <div class="card-body">
                <h5 class="card-title">
                    <i class="fas fa-map-marked-alt text-info"></i> Regions
                </h5>
                <h3 class="text-info">{{ regions.count }}</h3>
            </div>
        </div>
    </div>
</div>

<!-- Data Controls -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-download"></i> Data Management
            </div>
            <div class="card-body">
                <button class="btn btn-primary" onclick="parseAllData()">
                    <i class="fas fa-sync"></i> Parse All Data
                </button>
                <button class="btn btn-info ms-2" onclick="refreshDashboard()">
                    <i class="fas fa-refresh"></i> Refresh Dashboard
                </button>
                <div id="parseStatus" class="mt-3"></div>
            </div>
        </div>
    </div>
</div>

<!-- Quick Charts -->
<div class="row">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-thermometer-half"></i> UK Temperature Trend
            </div>
            <div class="card-body">
                <canvas id="tempChart" height="200"></canvas>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-cloud-rain"></i> UK Rainfall Trend
            </div>
            <div class="card-body">
                <canvas id="rainChart" height="200"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Data Tables -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-table"></i> Recent Weather Data
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped" id="weatherTable">
                        <thead>
                            <tr>
                                <th>Region</th>
                                <th>Parameter</th>
                                <th>Year</th>
                                <th>Month</th>
                                <th>Value</th>
                                <th>Unit</th>
                            </tr>
                        </thead>
                        <tbody id="weatherTableBody">
                            <tr>
                                <td colspan="6" class="text-center">Loading...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// Dashboard JavaScript
let tempChart, rainChart;

// Initialize dashboard
document.addEventListener('DOMContentLoaded', function() {
    loadWeatherData();
    initializeCharts();
});

// Parse all data function
function parseAllData() {
    const statusDiv = document.getElementById('parseStatus');
    statusDiv.innerHTML = '<div class="alert alert-info"><i class="fas fa-spinner fa-spin"></i> Parsing data...</div>';
    
    fetch('/api/parse-data/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            statusDiv.innerHTML = '<div class="alert alert-success"><i class="fas fa-check"></i> Data parsing completed successfully!</div>';
            setTimeout(refreshDashboard, 2000);
        } else {
            statusDiv.innerHTML = '<div class="alert alert-danger"><i class="fas fa-exclamation-triangle"></i> Error parsing data</div>';
        }
    })
    .catch(error => {
        console.error('Error:', error);
        statusDiv.innerHTML = '<div class="alert alert-danger"><i class="fas fa-exclamation-triangle"></i> Error parsing data</div>';
    });
}

// Refresh dashboard
function refreshDashboard() {
    location.reload();
}

// Load weather data for table
function loadWeatherData() {
    fetch('/api/weather-data/?limit=50')
        .then(response => response.json())
        .then(data => {
            const tbody = document.getElementById('weatherTableBody');
            tbody.innerHTML = '';
            
            if (data.results && data.results.length > 0) {
                data.results.forEach(record => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${record.region_name}</td>
                        <td>${record.parameter_name}</td>
                        <td>${record.year}</td>
                        <td>${record.month}</td>
                        <td>${record.value}</td>
                        <td>${record.parameter_unit}</td>
                    `;
                    tbody.appendChild(row);
                });
            } else {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center">No data available</td></tr>';
            }
        })
        .catch(error => {
            console.error('Error loading weather data:', error);
            document.getElementById('weatherTableBody').innerHTML = 
                '<tr><td colspan="6" class="text-center text-danger">Error loading data</td></tr>';
        });
}

// Initialize charts
function initializeCharts() {
    // Temperature Chart
    const tempCtx = document.getElementById('tempChart').getContext('2d');
    tempChart = new Chart(tempCtx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: 'Temperature (Â°C)',
                data: [],
                borderColor: 'rgb(255, 99, 132)',
                backgroundColor: 'rgba(255, 99, 132, 0.2)',
                tension: 0.1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: false
                }
            }
        }
    });

    // Rainfall Chart
    const rainCtx = document.getElementById('rainChart').getContext('2d');
    rainChart = new Chart(rainCtx, {
        type: 'bar',
        data: {
            labels: [],
            datasets: [{
                label: 'Rainfall (mm)',
                data: [],
                backgroundColor: 'rgba(54, 162, 235, 0.8)',
                borderColor: 'rgba(54, 162, 235, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });

    // Load chart data
    loadChartData();
}

// Load chart data
function loadChartData() {
    // Load temperature data
    fetch('/api/chart-data/?region=UK&parameter=Tmean')
        .then(response => response.json())
        .then(data => {
            if (data.labels && data.values) {
                // Show last 24 months only
                const recentData = data.labels.slice(-24).map((label, index) => ({
                    label: label,
                    value: data.values[data.values.length - 24 + index]
                }));
                
                tempChart.data.labels = recentData.map(d => d.label);
                tempChart.data.datasets[0].data = recentData.map(d => d.value);
                tempChart.update();
            }
        })
        .catch(error => console.error('Error loading temperature data:', error));

    // Load rainfall data
    fetch('/api/chart-data/?region=UK&parameter=Rainfall')
        .then(response => response.json())
        .then(data => {
            if (data.labels && data.values) {
                // Show last 24 months only
                const recentData = data.labels.slice(-24).map((label, index) => ({
                    label: label,
                    value: data.values[data.values.length - 24 + index]
                }));
                
                rainChart.data.labels = recentData.map(d => d.label);
                rainChart.data.datasets[0].data = recentData.map(d => d.value);
                rainChart.update();
            }
        })
        .catch(error => console.error('Error loading rainfall data:', error));
}
</script>
{% endblock %}